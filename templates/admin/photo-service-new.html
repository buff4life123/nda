
<style>
li { list-style-type:none}
ul{padding: 0px}
.table-condensed>tbody>tr>td, .table-condensed>tbody>tr>th, .table-condensed>tfoot>tr>td, .table-condensed>tfoot>tr>th, .table-condensed>thead>tr>td, .table-condensed>thead>tr>th {border: 0px solid #FFF!important}
.w3-input {border-bottom: 0px solid #05788d}
input, select, textarea {color: #000!important}

.parsley-required, .parsley-type, .parsley-pattern, .parsley-min, .parsley-max, .parsley-length, .parsley-errors-list {
    color: #f44336!important;
    padding: 8px 4px;
    animation: animatezoom 0.6s;
}
.sucess-msg {
    color: #33ff00!important;
}

</style>
<header class="w3-container" style="padding-top:22px">
    <h5><b><i class="far fa-images"></i> {%trans%}photo_service{%endtrans%}<i class="far fa-plus-square fa-fw"></i></b></h5>
</header>

<div class="w3-padding-16 w3-container">
  
  <div class="w3-border w3-sand">
    <form id="photo-service-form"  enctype="multipart/form-data">  
  {# {{ form_start(form, {'attr': {'id': 'photo-service-form'}})  }}
  {{ form_row(form._token) }} #}

  <div class="w3-row-padding w3-margin-top w3-border-bottom">

    <div class="w3-col s0 l3 m2 w3-hide-small">&nbsp;</div>

    <div class="w3-col s12 l6 m8 w3-center">
      <div class="w3-row-padding w3-margin-top w3-border-bottom">
          <div class="w3-col l6 m6 s12 w3-margin-bottom">
              {%trans%}name{%endtrans%}<br>
              <input class="w3-input w3-border w3-white" type="text" name="name"  required>
          </div>
          <div class="w3-col l6 m6 s12 w3-margin-bottom">
            {# {{ form_label(form.email)}}<br>
            {{ form_widget(form.email)}} #}
            Email<br>
            <input class="w3-input w3-border w3-white" type="email" name="email"  pattern="/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/" required>
          </div>
          <div class="w3-col l6 m6 s12 w3-margin-bottom">
            {# {{ form_label(form.telephone)}}<br>
            {{ form_widget(form.telephone)}} #}
            {%trans%}telephone{%endtrans%}<br>
            <input class="w3-input w3-border w3-white" type="tel" name="telephone" pattern="^[0-9-+s()]*$" required>
          </div>
          <div class="w3-col l6 m6 s12 w3-margin-bottom">
            {# {{ form_label(form.locales)}}<br>
            {{ form_widget(form.locales)}} #}
            {%trans%}language_sms{%endtrans%}<br>
            <select class="w3-input w3-select w3-border w3-white" name="locales">
              {%for local in locales %}
              <option value="{{local.id}}">{{local.name}}</option>
              {% endfor %}
            </select>
          </div>
          
        </div>
        
      <!-- <input type="number" name="number"> -->
      <div class="w3-row-padding w3-margin-top ">
        <label class="w3-text-red">{%trans%}max_selected_images{%endtrans%}: 300</label>
        <div id="previews" class="w3-white w3-center w3-margin-bottom w3-border w3-imput w3-section set-image-container w3-padding" title="{%trans%}add_image{%endtrans%}" style="cursor:pointer"onclick="$('.set-image').trigger('click')">
          <i id="no-image" class="fa fa-camera w3-jumbo" style="color:#05788d"></i>
        </div>
        <input id="images" class="w3-hide set-image" type="file" accept="image/*" name="images[]" required multiple>
        {# {{ form_widget(form.imageFile)}} #}
        {# <input type="file" name="previews" class="set-image" multiple> #}
        </div>
        <progress id="progressBar" class="w3-margin-top w3-hide" value="0" max="100" style="width:300px;"></progress>
        <h3 id="status"></h3>
        <p id="loaded_n_total"></p>
      </div> 
    </div>
  </div>

    <div class="w3-hide">
      {# {{ form_widget(form.submit)}} #}
      <input type="submit" value="Upload">
    </div>
  </div>
    <div class="w3-row-padding w3-margin-top w3-border-bottom">
      <div class="w3-col s12 w3-margin-bottom">
        <span id="submit-button" class="w3-btn w3-border w3-green w3-right w3-margin-top" onclick="$('#photo-service-form').trigger('submit')" disabled>
            <i class="fa fa-check"></i> {%trans%}save{%endtrans%}
          </span>
      </div>
    </div>
    {# {{ form_end(form) }} #}
  </form>
  </div>
</div>

<script src="{{ asset('/js/main.js') }}" type="text/javascript"></script>
<script>
  //<ul class="parsley-errors-list filled" id="parsley-id-44"><li class="parsley-required">Obrigat√≥rio *</li></ul>
  var progressBar = document.getElementById('progressBar');  
  var fileInput = document.querySelector('input[type="file"]');  

  fileInput.addEventListener('change', function(e) {

    $imgSelectedTranslate = e.target.files.length > 1 ? (e.target.files.length + " " + '{%trans%}selected_images{%endtrans%}') : e.target.files[0].name;
    $("#previews").html($imgSelectedTranslate);
     
    $maxFileUploads = 300;
    if (e.target.files.length > $maxFileUploads){
      $("#previews").html('{%trans%}upload_maximum{%endtrans%} ' + $maxFileUploads + ' {%trans%}images{%endtrans%}');
      $("#submit-button").addClass("w3-hide");
     } else {
      $("#submit-button").removeClass("w3-hide");
     }
  }, false);

  $("#photo-service-form").parsley()
  
  $('#photo-service-form').on('submit',function(e){

    obj=''

    form = new FormData($(this)[0])

    e.preventDefault()
    $('.w3-overlay').show()
    $('#progressBar,#status,#loaded_n_total').removeClass("w3-hide");
    //$('.required').addClass('w3-hide')
    //setTimeout(function(){
      $.ajax({  
        url:'{{ path('admin_photo_service_add') }}',
        type: "POST",
        data: form,
        processData: false,
        contentType: false,
        cache: false,
        xhr: function(){
        // get the native XmlHttpRequest object
        var xhr = $.ajaxSettings.xhr() ;
        xhr.upload.addEventListener("progress", progressHandler, false);//onprogress = function(evt){ progressHandler(evt) } ;
        xhr.addEventListener("load", completeHandler, false);
        xhr.addEventListener("error", errorHandler, false);
        xhr.addEventListener("abort", abortHandler, false);
       
        return xhr ;
        },
        success: function(data){  
          $('.w3-overlay').hide()
          
          //console.log("data:"+ data.id);
          if (data.status == 1){

            $("#photo-service-form").append("<h1 class='sucess-msg w3-center'>  {%trans%}sucess_msg{%endtrans%}</h1>");
            //$("#photo-service-form").closest('form').find("input[type=text], textarea").val("");

            $('#photo-service-form')[0].reset();
            $("#previews").html('<i id="no-image" class="fa fa-camera w3-jumbo" style="color:#05788d"></i>');
            $('#progressBar,#status,#loaded_n_total').addClass("w3-hide");
     

            setTimeout(
            function() 
            {
              $(".sucess-msg").remove();
            }, 1000);
   
            startZipRequest(data.id);
          }
          else {
            if(data.message === "fail")
              customError("previews", '{%trans%}error{%endtrans%} ....')
            else{
              customError(data.message, '{%trans%}invalid_field{%endtrans%} ....')
            }
              
          }
        },
        error:function(data){
          $('.w3-overlay').hide()
          $('#modal-error').show()
        }
      })
    //}, 500)
  }) 

  function startZipRequest(id) {

    $.ajax({  
      url:'{{ path('admin_photo_service_zip') }}',
      type: "POST",
      data: 'id='+id,
      success: function(data){

        if (data.status == 1){
            console.log("sucess");
        }else {
          console.log("error");
        }
          
      }
    })

  }


  function progressHandler(event) {

    $("#loaded_n_total").html("Uploaded " + parseFloat(event.loaded * Math.pow(10,-6)).toFixed(1) 
    + " Mb of " + parseFloat(event.total * Math.pow(10,-6)).toFixed(1)+ " Mb");
    
    var percent = (event.loaded / event.total) * 100;
    progressBar.value = Math.round(percent);
    $("#status").html(Math.round(percent) + "% uploaded... please wait");

    //if(Math.round(percent) == 100) {
    //  $("#status").html("compressing images... please wait");
    //}

  }

  function completeHandler(event) {
    //console.log(event)
    $("#status").html(event.target.responseText.message);
    progressBar.value = 0; //wil clear progress bar after successful upload
  }

  function errorHandler(event) {
    $("#status").html("Upload Failed");
    $('.w3-overlay').hide()
    setTimeout(
            function() 
            {
              ajaxUpload('photo-service-new')
            }, 4000);
  }

  function abortHandler(event) {
    $("#status").html("Upload Aborted");
    $('.w3-overlay').hide()
    setTimeout(
            function() 
            {
              ajaxUpload('photo-service-new')
            }, 4000);
  }


</script>

